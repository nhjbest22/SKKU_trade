<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            html,
            body {
                height: 100%;
                padding: 0;
                margin: 0;
            }
            #map {
                /* 지도 영역 */
                width: 100%;
                height: 400px;
                border-radius: 8px;
                overflow: hidden;
            }
        </style>
        <link rel="stylesheet" href="css/style.css" />
        <script src="localStorage.js"></script>
    </head>
    <body
        class="flex items-center justify-center min-h-screen"
        style="background-color: rgb(255, 255, 255)"
    >
        <div class="w-full max-w-sm bg-white rounded-lg shadow-md p-6">
            <!-- 헤더 -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-lg font-bold flex items-center gap-2">
                    <svg
                        class="h-6 w-6 text-gray-900"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                        />
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                    </svg>
                    거래 위치 설정
                </h1>
                <button
                    class="primary text-white px-4 py-1 rounded-md hover:bg-green-700"
                    id="save-location"
                >
                    저장
                </button>
            </div>

            <div class="mb-4">
                <input
                    type="text"
                    id="search-input"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-green-200"
                    placeholder="위치를 입력하세요"
                />
                <p id="search-error" class="text-sm text-red-500 mt-2 hidden">
                    위치를 찾을 수 없습니다.
                </p>
            </div>

            <!-- 지도 -->
            <div id="map"></div>
        </div>

        <script>
            const username = localStorage.getItem("username")
                ? localStorage.getItem("username")
                : "admin";

            const userData = findData("location", username);
            console.log(userData);

            let map;

            if (userData) {
                map = L.map("map").setView(
                    { lon: userData.lon, lat: userData.lat },
                    16
                );
            } else {
                map = L.map("map").setView({ lon: 126.9749, lat: 37.2938 }, 16);
            }

            L.tileLayer("https://tiles.osm.kr/hot/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution:
                    '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap 기여자</a>',
            }).addTo(map);

            L.control.scale({ imperial: true, metric: true }).addTo(map);

            let currentMarker = null;

            map.on("click", function (e) {
                const { lat, lng } = e.latlng;

                // 기존 마커 제거
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }

                setData("location", { lat, lon: lng, username });

                // 새로운 마커 추가
                currentMarker = L.marker([lat, lng])
                    .bindPopup(
                        `클릭한 위치: <br> 위도: ${lat.toFixed(
                            4
                        )}, 경도: ${lng.toFixed(4)}`
                    )
                    .addTo(map)
                    .openPopup();
            });

            // 검색 기능
            const searchInput = document.getElementById("search-input");
            const searchError = document.getElementById("search-error");

            searchInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    const query = searchInput.value;

                    if (!query) {
                        searchError.textContent = "검색어를 입력하세요.";
                        searchError.classList.remove("hidden");
                        return;
                    }

                    searchError.classList.add("hidden");

                    // OpenStreetMap Nominatim API를 사용한 위치 검색
                    fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                            query
                        )}`
                    )
                        .then((response) => response.json())
                        .then((data) => {
                            if (data && data.length > 0) {
                                const { lat, lon } = data[0];
                                map.setView([lat, lon], 15); // 검색된 위치로 지도 이동

                                // 기존 마커 제거
                                if (currentMarker) {
                                    map.removeLayer(currentMarker);
                                }

                                setData("location", {
                                    lat,
                                    lon: lng,
                                    username,
                                });

                                // 새로운 마커 추가
                                currentMarker = L.marker([lat, lon])
                                    .bindPopup(
                                        `검색된 위치: <br> 위도: ${parseFloat(
                                            lat
                                        ).toFixed(4)}, 경도: ${parseFloat(
                                            lon
                                        ).toFixed(4)}`
                                    )
                                    .addTo(map)
                                    .openPopup();
                            } else {
                                searchError.textContent =
                                    "검색 결과를 찾을 수 없습니다.";
                                searchError.classList.remove("hidden");
                            }
                        })
                        .catch((error) => {
                            searchError.textContent =
                                "검색 중 문제가 발생했습니다.";
                            searchError.classList.remove("hidden");
                        });
                }
            });

            const saveLocationButton = document.getElementById("save-location");
            saveLocationButton.addEventListener("click", function () {
                alert("위치가 저장되었습니다.");
            });
        </script>
    </body>
</html>
